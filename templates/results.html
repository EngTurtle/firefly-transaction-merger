{% if error %}
<div class="error">{{ error }}</div>
{% elif matches %}
<h3>Found {{ matches|length }} matching pair(s)</h3>

<div class="bulk-actions">
    <button id="merge-selected-btn"
            class="merge-all-btn"
            disabled>
        <span class="htmx-indicator">Merging...</span>
        <span class="default-text">Merge Selected (0)</span>
    </button>
</div>

<table class="results-table">
    <thead>
        <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th colspan="3">Withdrawal</th>
            <th>Amount</th>
            <th colspan="3">Deposit</th>
            <th>Days</th>
            <th>Action</th>
        </tr>
        <tr>
            <th></th>
            <th>Date</th>
            <th>From Account</th>
            <th>Description</th>
            <th></th>
            <th>Date</th>
            <th>To Account</th>
            <th>Description</th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for match in matches %}
        <tr id="row-{{ match.deposit.id }}-{{ match.primary_match.withdrawal.id }}"
            data-deposit-id="{{ match.deposit.id }}"
            {% if match.alternatives %}
            class="has-alternatives"
            data-alternatives='{{ match.alternatives_json }}'
            {% endif %}>
            <td>
                <input type="checkbox"
                       class="merge-checkbox"
                       value="{{ match.deposit.id }}:{{ match.primary_match.withdrawal.id }}">
            </td>
            <td class="withdrawal-cell{% if match.alternatives %} has-alts{% endif %}"
                {% if match.alternatives %}
                onclick="toggleAlternatives('{{ match.deposit.id }}')"
                title="Click to view {{ match.alternatives|length }} other match{{ 'es' if match.alternatives|length > 1 else '' }}"
                {% endif %}>
                <span class="withdrawal-date">{{ match.primary_match.withdrawal_split.date.strftime('%Y-%m-%d') }}</span>
                {% if match.alternatives %}
                <span class="alt-indicator">⚠️ +{{ match.alternatives|length }}</span>
                {% endif %}
            </td>
            <td class="withdrawal-cell{% if match.alternatives %} has-alts{% endif %}"
                {% if match.alternatives %}
                onclick="toggleAlternatives('{{ match.deposit.id }}')"
                title="Click to view {{ match.alternatives|length }} other match{{ 'es' if match.alternatives|length > 1 else '' }}"
                {% endif %}>
                {{ match.primary_match.withdrawal_split.source_name }}
            </td>
            <td class="withdrawal-cell{% if match.alternatives %} has-alts{% endif %}"
                {% if match.alternatives %}
                onclick="toggleAlternatives('{{ match.deposit.id }}')"
                title="Click to view {{ match.alternatives|length }} other match{{ 'es' if match.alternatives|length > 1 else '' }}"
                {% endif %}>
                {{ match.primary_match.withdrawal_split.description }}
            </td>
            <td>{{ match.primary_match.withdrawal_split.currency_symbol }}{{ "%.2f"|format(match.amount) }}</td>
            <td>{{ match.deposit_split.date.strftime('%Y-%m-%d') }}</td>
            <td>{{ match.deposit_split.destination_name }}</td>
            <td>{{ match.deposit_split.description }}</td>
            <td>{{ match.primary_match.days_apart }}</td>
            <td>
                <button
                    class="merge-btn single-merge-btn"
                    data-deposit-id="{{ match.deposit.id }}"
                    data-withdrawal-id="{{ match.primary_match.withdrawal.id }}">
                    <span class="default-text">Merge</span>
                </button>
            </td>
        </tr>
        {% if match.alternatives %}
        <tr id="alt-row-{{ match.deposit.id }}" class="alternatives-row" style="display:none;">
            <td colspan="10">
                <div class="alternatives-container">
                    <h4>Alternative Matches</h4>
                    <table class="alternatives-table">
                        <thead>
                            <tr>
                                <th>Withdrawal Date</th>
                                <th>From Account</th>
                                <th>Description</th>
                                <th>Days Apart</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="alt-body-{{ match.deposit.id }}">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                    <button class="hide-alternatives-btn" onclick="toggleAlternatives('{{ match.deposit.id }}')">
                        Hide Alternatives
                    </button>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

<script>
(function() {
    const selectAll = document.getElementById('select-all');
    const mergeBtn = document.getElementById('merge-selected-btn');

    function updateMergeButton() {
        const checked = document.querySelectorAll('.merge-checkbox:checked');
        mergeBtn.disabled = checked.length === 0;
        mergeBtn.querySelector('.default-text').textContent = `Merge Selected (${checked.length})`;
    }

    selectAll.addEventListener('change', function() {
        document.querySelectorAll('.merge-checkbox').forEach(cb => {
            cb.checked = this.checked;
        });
        updateMergeButton();
    });

    document.querySelectorAll('.merge-checkbox').forEach(cb => {
        cb.addEventListener('change', updateMergeButton);
    });

    // Bulk merge state management
    let isMerging = false;
    let shouldStop = false;
    let currentMergeIndex = 0;

    mergeBtn.addEventListener('click', async function() {
        const checkedBoxes = Array.from(document.querySelectorAll('.merge-checkbox:checked'));

        if (isMerging) {
            // Stop button clicked
            shouldStop = true;
            mergeBtn.disabled = true;
            mergeBtn.querySelector('.default-text').textContent = 'Stopping...';
            return;
        }

        if (checkedBoxes.length === 0) return;

        // Start merging
        isMerging = true;
        shouldStop = false;
        mergeBtn.querySelector('.default-text').textContent = 'Stop Merge';
        mergeBtn.disabled = false;

        // Disable select-all and individual checkboxes
        selectAll.disabled = true;
        document.querySelectorAll('.merge-checkbox').forEach(cb => cb.disabled = true);

        const totalCount = checkedBoxes.length;
        let completed = 0;
        const pollInterval = 500;

        // Process each pair sequentially
        for (let i = 0; i < checkedBoxes.length; i++) {
            if (shouldStop) {
                break;
            }

            const cb = checkedBoxes[i];
            const [depositId, withdrawalId] = cb.value.split(':');
            const row = document.getElementById(`row-${depositId}-${withdrawalId}`);

            try {
                // Mark row as processing
                row.classList.add('processing');

                // Submit job
                const response = await fetch(`/merge/${depositId}/${withdrawalId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.error) {
                    row.outerHTML = `<tr class="merge-error"><td colspan="10">
                        <span class="error">${data.error}</span>
                        <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                    </td></tr>`;
                    completed++;
                    continue;
                }

                // Poll for job completion
                const jobId = data.job_id;
                let jobComplete = false;

                while (!jobComplete && !shouldStop) {
                    const statusResponse = await fetch(`/job-status/${jobId}`);
                    const status = await statusResponse.json();

                    if (status.status === 'completed') {
                        row.outerHTML = `<tr class="merge-success"><td colspan="10">
                            Merged successfully! Created transfer from ${status.result.source_name}
                            to ${status.result.destination_name}.
                        </td></tr>`;
                        completed++;
                        jobComplete = true;
                    } else if (status.status === 'failed') {
                        row.outerHTML = `<tr class="merge-error"><td colspan="10">
                            <span class="error">Merge failed: ${status.error}</span>
                            <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                        </td></tr>`;
                        completed++;
                        jobComplete = true;
                    } else {
                        // Still pending or processing, wait and poll again
                        await new Promise(resolve => setTimeout(resolve, pollInterval));
                    }
                }

            } catch (error) {
                console.error(`Failed to merge ${depositId}:${withdrawalId}`, error);
                row.outerHTML = `<tr class="merge-error"><td colspan="10">
                    <span class="error">Failed: ${error.message}</span>
                    <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                </td></tr>`;
                completed++;
            }

            // Update progress
            if (!shouldStop) {
                mergeBtn.querySelector('.default-text').textContent =
                    `Stop Merge (${completed}/${totalCount})`;
            }
        }

        // Reset state
        isMerging = false;
        shouldStop = false;
        mergeBtn.disabled = true;
        selectAll.disabled = false;
        document.querySelectorAll('.merge-checkbox').forEach(cb => cb.disabled = false);

        const remainingChecked = document.querySelectorAll('.merge-checkbox:checked').length;
        mergeBtn.querySelector('.default-text').textContent =
            remainingChecked > 0 ? `Merge Selected (${remainingChecked})` : 'Merge Selected (0)';
        mergeBtn.disabled = remainingChecked === 0;
    });

    // Handle individual merge button clicks
    document.querySelectorAll('.single-merge-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const depositId = this.dataset.depositId;
            const withdrawalId = this.dataset.withdrawalId;
            const row = document.getElementById(`row-${depositId}-${withdrawalId}`);

            // Disable button
            this.disabled = true;
            this.querySelector('.default-text').textContent = 'Queuing...';

            try {
                // Submit job
                const response = await fetch(`/merge/${depositId}/${withdrawalId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.error) {
                    row.outerHTML = `<tr class="merge-error"><td colspan="10">
                        <span class="error">${data.error}</span>
                        <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                    </td></tr>`;
                    return;
                }

                this.querySelector('.default-text').textContent = 'Processing...';
                row.classList.add('processing');

                // Poll for status
                const jobId = data.job_id;
                const pollInterval = 500;

                while (true) {
                    const statusResponse = await fetch(`/job-status/${jobId}`);
                    const status = await statusResponse.json();

                    if (status.status === 'completed') {
                        row.outerHTML = `<tr class="merge-success"><td colspan="10">
                            Merged successfully! Created transfer from ${status.result.source_name}
                            to ${status.result.destination_name}.
                        </td></tr>`;
                        break;
                    } else if (status.status === 'failed') {
                        row.outerHTML = `<tr class="merge-error"><td colspan="10">
                            <span class="error">Merge failed: ${status.error}</span>
                            <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                        </td></tr>`;
                        break;
                    }

                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                }
            } catch (error) {
                console.error('Merge failed:', error);
                row.outerHTML = `<tr class="merge-error"><td colspan="10">
                    <span class="error">Merge failed: ${error.message}</span>
                    <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                </td></tr>`;
            }
        });
    });
})();

// Alternative matches functions
function toggleAlternatives(depositId) {
    const mainRow = document.querySelector(`tr[data-deposit-id="${depositId}"]`);
    const altRow = document.getElementById(`alt-row-${depositId}`);

    if (altRow.style.display === 'none') {
        // Show alternatives - populate table from data attribute
        const alternatives = JSON.parse(mainRow.dataset.alternatives);
        const tbody = document.getElementById(`alt-body-${depositId}`);

        tbody.innerHTML = alternatives.map(alt => `
            <tr>
                <td>${formatDate(alt.withdrawal_split.date)}</td>
                <td>${escapeHtml(alt.withdrawal_split.source_name)}</td>
                <td>${escapeHtml(alt.withdrawal_split.description)}</td>
                <td>${alt.days_apart}</td>
                <td>
                    <button class="merge-btn alt-merge-btn"
                            onclick="selectAlternative('${depositId}', '${alt.withdrawal.id}')">
                        Select This
                    </button>
                </td>
            </tr>
        `).join('');

        altRow.style.display = 'table-row';
    } else {
        // Hide alternatives
        altRow.style.display = 'none';
    }
}

function selectAlternative(depositId, withdrawalId) {
    const mainRow = document.querySelector(`tr[data-deposit-id="${depositId}"]`);
    const cells = mainRow.querySelectorAll('td');

    // Get current alternatives list
    const alternatives = JSON.parse(mainRow.dataset.alternatives);

    // Find the selected alternative in the list and get its full data
    const selectedAltIndex = alternatives.findIndex(alt => alt.withdrawal.id === withdrawalId);
    const selectedAlt = alternatives[selectedAltIndex];

    // Get current primary withdrawal data from the row
    const currentPrimaryDate = cells[1].querySelector('.withdrawal-date').textContent;
    const currentPrimarySourceName = cells[2].textContent;
    const currentPrimaryDescription = cells[3].textContent;
    const currentPrimaryDaysApart = parseInt(cells[8].textContent);

    // Extract current primary withdrawal ID from row ID
    const currentRowId = mainRow.id;
    const currentPrimaryWithdrawalId = currentRowId.split('-')[2];

    // Create entry for the current primary (to move to alternatives)
    const previousPrimary = {
        withdrawal: { id: currentPrimaryWithdrawalId },
        withdrawal_split: {
            date: currentPrimaryDate,
            source_name: currentPrimarySourceName,
            description: currentPrimaryDescription
        },
        days_apart: currentPrimaryDaysApart
    };

    // Update alternatives: remove selected, add previous primary
    const newAlternatives = alternatives.filter((_, idx) => idx !== selectedAltIndex);
    newAlternatives.push(previousPrimary);

    // Sort by days_apart
    newAlternatives.sort((a, b) => a.days_apart - b.days_apart);

    // Update the data-alternatives attribute
    mainRow.dataset.alternatives = JSON.stringify(newAlternatives);

    // Update row ID for correct HTMX targeting
    mainRow.id = `row-${depositId}-${withdrawalId}`;

    // Update withdrawal date cell (has nested spans)
    cells[1].innerHTML = `<span class="withdrawal-date">${formatDate(selectedAlt.withdrawal_split.date)}</span> <span class="alt-indicator">⚠️ +${newAlternatives.length}</span>`;

    // Update from account and description
    cells[2].textContent = selectedAlt.withdrawal_split.source_name;
    cells[3].textContent = selectedAlt.withdrawal_split.description;

    // Update days apart
    cells[8].textContent = selectedAlt.days_apart;

    // Update checkbox value
    const checkbox = cells[0].querySelector('.merge-checkbox');
    checkbox.value = `${depositId}:${withdrawalId}`;

    // Update merge button's hx-post URL
    const mergeBtn = mainRow.querySelector('.merge-btn');
    mergeBtn.setAttribute('hx-post', `/merge/${depositId}/${withdrawalId}`);
    mergeBtn.setAttribute('hx-target', `#row-${depositId}-${withdrawalId}`);

    // Re-initialize HTMX for the updated button
    htmx.process(mergeBtn);

    // Hide alternatives
    toggleAlternatives(depositId);
}

function formatDate(dateStr) {
    // Handle ISO datetime string from API or already formatted date
    if (typeof dateStr === 'string' && dateStr.includes('T')) {
        return dateStr.split('T')[0];
    }
    return dateStr;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% else %}
<p class="no-results">No matching transaction pairs found for the given criteria.</p>
{% endif %}
